/*
================================================================================
 Nextflow Config for CRDC Uploader Pipeline
================================================================================
*/

profiles {

  // ---------- Plain docker profile ----------
  docker {
    docker.enabled = true
  }

  // ---------- Test / CI ----------
  test {
    process.executor = 'local'
    docker.enabled   = true

    // Use a small samplesheet for quick tests
    params.input   = 'samplesheet.csv'
    params.dry_run = true
  }

  // ---------- Seqera Tower profiles ----------
  sage  { includeConfig 'conf/sage.config'  }
  tower { includeConfig 'conf/tower.config' }
}

/*
================================================================================
 Parameters
================================================================================
*/
params {
  // Path to samplesheet; defaults to projectDir/samplesheet.csv in main.nf
  input     = null
  dry_run   = false
  overwrite = true
}

/*
================================================================================
 Plugins
================================================================================
*/
plugins {
  id 'nf-schema@2.2.0'
  id 'nf-boost'
}

boost {
  cleanup = false
}

/*
================================================================================
 Tracing / Reports
================================================================================
*/
trace {
  enabled   = true
  overwrite = true
  file      = 'reports/trace.csv'
  sep       = ','
  fields    = 'task_id,hash,native_id,name,status,exit,submit,duration,realtime,%cpu,peak_rss,peak_vmem,rchar,wchar'
}

/*
================================================================================
 Docker defaults
================================================================================
*/
docker.enabled = true

/*
================================================================================
 Environment mapping for Tower Secrets
================================================================================
 Map Tower secrets into env vars so processes can access them.
================================================================================
*/
env {
  SYNAPSE_AUTH_TOKEN = "${System.getenv('TOWER_SECRET_SYNAPSE_AUTH_TOKEN') ?: System.getenv('SYNAPSE_AUTH_TOKEN')}"
  CRDC_API_TOKEN     = "${System.getenv('TOWER_SECRET_CRDC_API_TOKEN')     ?: System.getenv('CRDC_API_TOKEN')}"
  CRDC_SUBMISSION_ID = "${System.getenv('TOWER_SECRET_CRDC_SUBMISSION_ID') ?: System.getenv('CRDC_SUBMISSION_ID')}"
}
