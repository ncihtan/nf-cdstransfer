/*
================================================================================
 Nextflow Config for CRDC Transfer Pipeline
================================================================================
*/

profiles {

  // ---------- Plain Docker profile ----------
  docker {
    docker.enabled = true
  }

  // ---------- Test / CI ----------
  test {
    process.executor = 'local'
    docker.enabled   = true
    // Optional: point to a tiny samplesheet in the repo for quick smoke tests
    // (If omitted, main.nf will default/resolve to ${projectDir}/samplesheet.tsv)
    // params.input   = 'samplesheet.tsv'
    params.dry_run = true
  }

  // ---------- Seqera Tower profiles ----------
  sage  { includeConfig 'conf/sage.config'  }
  tower { includeConfig 'conf/tower.config' }
}

/*
================================================================================
 Parameters (defaults)
 - Do NOT set params.input here to avoid double-assign warnings.
================================================================================
*/
params {
  input            = null   // resolved in main.nf to ${projectDir}/samplesheet.tsv if unset
  dry_run          = false  // passed down to uploader
  overwrite        = true
  submission_uuid  = null   // if unset, falls back to env:CRDC_SUBMISSION_ID
}

/*
================================================================================
 Plugins
================================================================================
*/
plugins {
  id 'nf-schema@2.2.0'
  id 'nf-boost'
}

boost {
  cleanup = false
}

/*
================================================================================
 Tracing / Reports
================================================================================
*/
trace {
  enabled   = true
  overwrite = true
  file      = 'reports/trace.csv'
  sep       = ','
  fields    = 'task_id,hash,native_id,name,status,exit,submit,duration,realtime,%cpu,peak_rss,peak_vmem,rchar,wchar'
}

/*
================================================================================
 Docker defaults
================================================================================
*/
docker.enabled = true

/*
================================================================================
 Environment mapping for Tower Secrets
 - These surface Tower secrets to the processes exactly as your main.nf expects.
================================================================================
*/
env {
  SYNAPSE_AUTH_TOKEN_DYP = "${System.getenv('TOWER_SECRET_SYNAPSE_AUTH_TOKEN_DYP') ?: System.getenv('SYNAPSE_AUTH_TOKEN_DYP')}"
  CRDC_API_TOKEN         = "${System.getenv('TOWER_SECRET_CRDC_API_TOKEN')     ?: System.getenv('CRDC_API_TOKEN')}"
  CRDC_SUBMISSION_ID     = "${System.getenv('TOWER_SECRET_CRDC_SUBMISSION_ID') ?: System.getenv('CRDC_SUBMISSION_ID')}"
}


/*
================================================================================
 Optional: process-specific overrides
 - If you previously had `withName:cds_upload { ... }`, rename it to `crdc_upload`.
================================================================================
*/
// process.withName:crdc_upload {
//   // Example: pin a prebuilt image instead of on-the-fly install
//   // container = 'ghcr.io/your-org/crdc-datahub-cli-uploader:sha-<digest>'
//   // cpus = 2
//   // memory = '4 GB'
//   // time = '2h'
// }
